<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">digitalnotes</a> &gt; <a href="index.source.html" class="el_package">com.group6.digitalnotes.controller</a> &gt; <span class="el_source">MainController.java</span></div><h1>MainController.java</h1><pre class="source lang-java linenums">package com.group6.digitalnotes.controller;

import com.group6.digitalnotes.dao.LocalizationDAO;
import com.group6.digitalnotes.dao.NoteDAO;
import com.group6.digitalnotes.model.Note;
import com.group6.digitalnotes.view.View;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.BorderPane;
import javafx.util.Duration;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;

<span class="nc" id="L24">public class MainController {</span>

    @FXML private BorderPane rootPane;
    @FXML private AnchorPane editorPane;
    @FXML private AnchorPane sidebar;
    @FXML private ListView&lt;String&gt; noteList;
    @FXML private TextField searchField;
    @FXML private TextField titleField;
    @FXML private TextArea contentArea;
    @FXML private Label timerLabel;
    @FXML private Button newNoteBtn;
    @FXML private Button deleteBtn;
    @FXML private Button toggleSidebarBtn;
    @FXML private Button logoutBtn;
    @FXML private MenuButton languageMenuBtn;
    @FXML private Label statusLabel;

<span class="nc" id="L41">    private final NoteDAO noteDAO = new NoteDAO();</span>
<span class="nc" id="L42">    private final LocalizationDAO localizationDAO = new LocalizationDAO();</span>

    private Map&lt;String, String&gt; localization;
<span class="nc" id="L45">    private final ObservableList&lt;String&gt; allNotes = FXCollections.observableArrayList();</span>
<span class="nc" id="L46">    private final ObservableList&lt;String&gt; filteredNotes = FXCollections.observableArrayList();</span>

<span class="nc" id="L48">    private boolean isSidebarHidden = true;</span>
<span class="nc" id="L49">    private boolean isTimerRunning = false;</span>
<span class="nc" id="L50">    private int timeRemaining = 15 * 60;</span>
    private Timeline timer;
<span class="nc" id="L52">    private boolean isArabic = false;</span>

    @FXML
    public void initialize() {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (View.loggedInUser == null) return;</span>

<span class="nc" id="L58">        rootPane.setRight(null);</span>
<span class="nc" id="L59">        loadLanguage(View.currentLanguage);</span>
<span class="nc" id="L60">        loadNotesFromDB();</span>

<span class="nc" id="L62">        searchField.textProperty().addListener((obs, oldVal, newVal) -&gt; filterNotes(newVal));</span>
<span class="nc" id="L63">        noteList.setOnMouseClicked(e -&gt; loadSelectedNote());</span>

<span class="nc" id="L65">        statusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L66">    }</span>

    private void loadLanguage(String langCode) {
<span class="nc" id="L69">        localization = localizationDAO.loadLanguage(langCode);</span>
<span class="nc" id="L70">        isArabic = langCode.equalsIgnoreCase(&quot;ar&quot;);</span>
<span class="nc" id="L71">        updateTexts();</span>
<span class="nc" id="L72">        statusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L73">    }</span>

    private void updateTexts() {
<span class="nc" id="L76">        newNoteBtn.setText(text(&quot;btn.new&quot;));</span>
<span class="nc" id="L77">        deleteBtn.setText(text(&quot;btn.delete&quot;));</span>
<span class="nc" id="L78">        toggleSidebarBtn.setText(text(&quot;btn.notes&quot;));</span>
<span class="nc" id="L79">        logoutBtn.setText(text(&quot;button.logout&quot;));</span>

<span class="nc" id="L81">        searchField.setPromptText(text(&quot;placeholder.search&quot;));</span>
<span class="nc" id="L82">        titleField.setPromptText(text(&quot;placeholder.title&quot;));</span>
<span class="nc" id="L83">        contentArea.setPromptText(text(&quot;placeholder.content&quot;));</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">        var orientation = isArabic</span>
<span class="nc" id="L86">                ? javafx.geometry.NodeOrientation.RIGHT_TO_LEFT</span>
<span class="nc" id="L87">                : javafx.geometry.NodeOrientation.LEFT_TO_RIGHT;</span>

<span class="nc" id="L89">        titleField.setNodeOrientation(orientation);</span>
<span class="nc" id="L90">        contentArea.setNodeOrientation(orientation);</span>
<span class="nc" id="L91">        searchField.setNodeOrientation(orientation);</span>
<span class="nc" id="L92">    }</span>

    private String text(String key) {
<span class="nc" id="L95">        return localization.getOrDefault(key, &quot;[&quot; + key + &quot;]&quot;);</span>
    }

<span class="nc" id="L98">    @FXML private void onSwitchToEnglish() { View.currentLanguage = &quot;en&quot;; loadLanguage(&quot;en&quot;); }</span>
<span class="nc" id="L99">    @FXML private void onSwitchToArabic() { View.currentLanguage = &quot;ar&quot;; loadLanguage(&quot;ar&quot;); }</span>
<span class="nc" id="L100">    @FXML private void onSwitchToJapanese() { View.currentLanguage = &quot;ja&quot;; loadLanguage(&quot;ja&quot;); }</span>

    private void setupTimer() {
<span class="nc" id="L103">        timer = new Timeline(new KeyFrame(Duration.seconds(1), e -&gt; Platform.runLater(this::updateTimer)));</span>
<span class="nc" id="L104">        timer.setCycleCount(Timeline.INDEFINITE);</span>
<span class="nc" id="L105">        updateTimerDisplay();</span>
<span class="nc" id="L106">    }</span>

    @FXML
    private void onTimerClicked() {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (timer == null) setupTimer();</span>
<span class="nc" id="L111">        toggleTimer();</span>
<span class="nc" id="L112">    }</span>

    private void toggleTimer() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (!isTimerRunning) {</span>
<span class="nc" id="L116">            isTimerRunning = true;</span>
<span class="nc" id="L117">            timeRemaining = 15 * 60;</span>
<span class="nc" id="L118">            updateTimerDisplay();</span>
<span class="nc" id="L119">            timer.play();</span>

<span class="nc" id="L121">            titleField.setEditable(true);</span>
<span class="nc" id="L122">            contentArea.setEditable(true);</span>
<span class="nc" id="L123">            titleField.clear();</span>
<span class="nc" id="L124">            contentArea.clear();</span>
<span class="nc" id="L125">            contentArea.requestFocus();</span>
        } else {
<span class="nc" id="L127">            stopAndSave();</span>
        }
<span class="nc" id="L129">    }</span>

    private void updateTimer() {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (timeRemaining &gt; 0) {</span>
<span class="nc" id="L133">            timeRemaining--;</span>
<span class="nc" id="L134">            updateTimerDisplay();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (timeRemaining &lt;= 60) {</span>
<span class="nc" id="L136">                timerLabel.setStyle(&quot;-fx-text-fill: darkred;&quot;);</span>
            }
        } else {
<span class="nc" id="L139">            stopAndSave();</span>
        }
<span class="nc" id="L141">    }</span>

    private void updateTimerDisplay() {
<span class="nc" id="L144">        int minutes = timeRemaining / 60;</span>
<span class="nc" id="L145">        int seconds = timeRemaining % 60;</span>
<span class="nc" id="L146">        timerLabel.setText(String.format(&quot;%02d:%02d&quot;, minutes, seconds));</span>
<span class="nc" id="L147">    }</span>

    private void stopAndSave() {
<span class="nc" id="L150">        isTimerRunning = false;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (timer != null) timer.stop();</span>

<span class="nc" id="L153">        String title = titleField.getText().trim();</span>
<span class="nc" id="L154">        String content = contentArea.getText().trim();</span>

<span class="nc bnc" id="L156" title="All 4 branches missed.">        if (title.isEmpty() &amp;&amp; !content.isEmpty()) {</span>
            title = &quot;Timed Session - &quot; +
<span class="nc" id="L158">                    LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;MM-dd HH:mm&quot;));</span>
        }

<span class="nc bnc" id="L161" title="All 4 branches missed.">        if (!title.isEmpty() &amp;&amp; !content.isEmpty()) {</span>
<span class="nc" id="L162">            int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L163">            Note note = new Note(userId, title, content);</span>
<span class="nc" id="L164">            noteDAO.addNote(note);</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (!allNotes.contains(title)) {</span>
<span class="nc" id="L167">                allNotes.add(title);</span>
<span class="nc" id="L168">                filterNotes(searchField.getText());</span>
<span class="nc" id="L169">                noteList.setItems(filteredNotes);</span>
            }

<span class="nc" id="L172">            setStatus(text(&quot;msg.noteSaved&quot;) + &quot;: &quot; + title, &quot;#00cc66&quot;);</span>
<span class="nc" id="L173">        } else {</span>
<span class="nc" id="L174">            setStatus(text(&quot;msg.noteNotSaved&quot;), &quot;#ee0000&quot;);</span>
        }

<span class="nc" id="L177">        resetTimer();</span>
<span class="nc" id="L178">    }</span>

    private void resetTimer() {
<span class="nc" id="L181">        timeRemaining = 15 * 60;</span>
<span class="nc" id="L182">        updateTimerDisplay();</span>
<span class="nc" id="L183">        titleField.clear();</span>
<span class="nc" id="L184">        contentArea.clear();</span>
<span class="nc" id="L185">        titleField.setEditable(false);</span>
<span class="nc" id="L186">        contentArea.setEditable(false);</span>
<span class="nc" id="L187">        timerLabel.setStyle(&quot;-fx-text-fill: black;&quot;);</span>
<span class="nc" id="L188">    }</span>

    private void loadNotesFromDB() {
<span class="nc" id="L191">        int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L192">        List&lt;Note&gt; notes = noteDAO.getNotesForUser(userId);</span>
<span class="nc" id="L193">        allNotes.clear();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        for (Note note : notes) {</span>
<span class="nc" id="L195">            allNotes.add(note.getTitle());</span>
<span class="nc" id="L196">        }</span>
<span class="nc" id="L197">        filteredNotes.setAll(allNotes);</span>
<span class="nc" id="L198">        noteList.setItems(filteredNotes);</span>
<span class="nc" id="L199">    }</span>

    private void filterNotes(String filter) {
<span class="nc" id="L202">        filteredNotes.clear();</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">        if (filter == null || filter.isBlank()) {</span>
<span class="nc" id="L204">            filteredNotes.addAll(allNotes);</span>
        } else {
<span class="nc" id="L206">            String f = filter.toLowerCase();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            for (String n : allNotes) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                if (n.toLowerCase().contains(f)) {</span>
<span class="nc" id="L209">                    filteredNotes.add(n);</span>
                }
<span class="nc" id="L211">            }</span>
        }
<span class="nc" id="L213">    }</span>

    private void loadSelectedNote() {
<span class="nc" id="L216">        String selected = noteList.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (selected != null) {</span>
<span class="nc" id="L218">            titleField.setText(selected);</span>
<span class="nc" id="L219">            int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L220">            String content = noteDAO.getNoteByTitle(userId, selected);</span>
<span class="nc" id="L221">            contentArea.setText(content);</span>
        }
<span class="nc" id="L223">    }</span>

    @FXML
    private void onNewNote(ActionEvent event) {
<span class="nc" id="L227">        titleField.setEditable(true);</span>
<span class="nc" id="L228">        contentArea.setEditable(true);</span>
<span class="nc" id="L229">        titleField.clear();</span>
<span class="nc" id="L230">        contentArea.clear();</span>
<span class="nc" id="L231">        setStatus(text(&quot;msg.newNote&quot;), &quot;#00cc66&quot;);</span>
<span class="nc" id="L232">    }</span>

    @FXML
    private void onDelete(ActionEvent event) {
<span class="nc" id="L236">        String selectedNote = noteList.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (selectedNote != null) {</span>
<span class="nc" id="L238">            int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L239">            noteDAO.deleteNoteByTitle(userId, selectedNote);</span>
<span class="nc" id="L240">            allNotes.remove(selectedNote);</span>
<span class="nc" id="L241">            filterNotes(searchField.getText());</span>
<span class="nc" id="L242">            noteList.setItems(filteredNotes);</span>
<span class="nc" id="L243">            setStatus(text(&quot;msg.noteDeleted&quot;) + &quot;: &quot; + selectedNote, &quot;#00cc66&quot;);</span>
<span class="nc" id="L244">        } else {</span>
<span class="nc" id="L245">            setStatus(text(&quot;msg.selectNote&quot;), &quot;#007bff&quot;);</span>
        }
<span class="nc" id="L247">    }</span>

    @FXML
    private void onToggleSidebar(ActionEvent event) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (isSidebarHidden) {</span>
<span class="nc" id="L252">            rootPane.setRight(sidebar);</span>
        } else {
<span class="nc" id="L254">            rootPane.setRight(null);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        isSidebarHidden = !isSidebarHidden;</span>
<span class="nc" id="L257">    }</span>

    private void setStatus(String msg, String color) {
<span class="nc" id="L260">        statusLabel.setText(msg);</span>
<span class="nc" id="L261">        statusLabel.setStyle(&quot;-fx-text-fill: &quot; + color + &quot;;&quot;);</span>

<span class="nc" id="L263">        Timeline clearStatus = new Timeline(new KeyFrame(Duration.seconds(4), e -&gt; {</span>
<span class="nc" id="L264">            statusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L265">            statusLabel.setStyle(&quot;-fx-text-fill: transparent;&quot;);</span>
<span class="nc" id="L266">        }));</span>
<span class="nc" id="L267">        clearStatus.setCycleCount(1);</span>
<span class="nc" id="L268">        clearStatus.play();</span>
<span class="nc" id="L269">    }</span>

    @FXML
    private void onLogout() {
<span class="nc" id="L273">        View.loggedInUser = null;</span>
<span class="nc" id="L274">        View.isLoggedIn = false;</span>
<span class="nc" id="L275">        View.switchScene(View.primaryStage, &quot;/fxml/login-view.fxml&quot;);</span>
<span class="nc" id="L276">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>