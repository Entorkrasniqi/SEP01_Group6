<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">digitalnotes</a> &gt; <a href="index.source.html" class="el_package">com.group6.digitalnotes.controller</a> &gt; <span class="el_source">MainController.java</span></div><h1>MainController.java</h1><pre class="source lang-java linenums">package com.group6.digitalnotes.controller;

import com.group6.digitalnotes.dao.LocalizationDAO;
import com.group6.digitalnotes.dao.NoteDAO;
import com.group6.digitalnotes.model.Note;
import com.group6.digitalnotes.view.View;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.application.Platform;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.BorderPane;
import javafx.util.Duration;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;

/**
 * Main application controller handling note editing, timer sessions,
 * sidebar navigation, search filtering, and localization updates.
 */
<span class="fc" id="L28">public class MainController {</span>

    @FXML private BorderPane rootPane;          // Container holding sidebar and editor
    @FXML private AnchorPane editorPane;        // Main editor area
    @FXML private AnchorPane sidebar;           // Notes list sidebar
    @FXML private ListView&lt;String&gt; noteList;    // Displays note titles
    @FXML private TextField searchField;        // Live search filter input
    @FXML private TextField titleField;         // Note title input
    @FXML private TextArea contentArea;         // Note content input
    @FXML private Label timerLabel;             // Clickable label to start/stop timed session
    @FXML private Button newNoteBtn;            // Create new note
    @FXML private Button deleteBtn;             // Delete selected note
    @FXML private Button toggleSidebarBtn;      // Show/hide sidebar
    @FXML private Button logoutBtn;             // Log out to login screen
    @FXML private MenuButton languageMenuBtn;   // Language selector
    @FXML private Label statusLabel;            // Temporary status messages

<span class="fc" id="L45">    private final NoteDAO noteDAO = new NoteDAO();</span>
<span class="fc" id="L46">    private final LocalizationDAO localizationDAO = new LocalizationDAO();</span>

    private Map&lt;String, String&gt; localization;   // Current language key/value pairs
<span class="fc" id="L49">    private final ObservableList&lt;String&gt; allNotes = FXCollections.observableArrayList();      // All titles for user</span>
<span class="fc" id="L50">    private final ObservableList&lt;String&gt; filteredNotes = FXCollections.observableArrayList(); // Filtered view of titles</span>

<span class="fc" id="L52">    private boolean isSidebarHidden = true;     // Tracks sidebar visibility</span>
<span class="fc" id="L53">    private boolean isTimerRunning = false;     // Tracks timer state</span>
<span class="fc" id="L54">    private int timeRemaining = 15 * 60;        // Timer duration in seconds (15 minutes)</span>
    private Timeline timer;                     // JavaFX repeating timer
<span class="fc" id="L56">    private boolean isArabic = false;           // Current language direction flag</span>
<span class="fc" id="L57">    private String color = &quot;#00cc66&quot;;            // Default text color</span>

    /** Initialize controller state, language, and listeners. */
    @FXML
    public void initialize() {
        // If user is not set (e.g., direct navigation), bail out to avoid NPEs
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (View.loggedInUser == null) return;</span>

<span class="nc" id="L65">        rootPane.setRight(null); // start with sidebar hidden</span>
<span class="nc" id="L66">        loadLanguage();          // Uses View.currentLanguage internally</span>
<span class="nc" id="L67">        loadNotesFromDB();</span>

        // Live filter as user types
<span class="nc" id="L70">        searchField.textProperty().addListener((obs, oldVal, newVal) -&gt; filterNotes(newVal));</span>
        // Load note on list click
<span class="nc" id="L72">        noteList.setOnMouseClicked(e -&gt; loadSelectedNote());</span>

<span class="nc" id="L74">        statusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L75">    }</span>

    /** Load localization based on the current global language and update UI texts. */
    private void loadLanguage() {
<span class="fc" id="L79">        String langCode = View.currentLanguage;</span>

<span class="fc" id="L81">        localization = localizationDAO.loadLanguage(langCode);</span>
<span class="fc" id="L82">        isArabic = langCode.equalsIgnoreCase(&quot;ar&quot;);</span>
<span class="fc" id="L83">        updateTexts();</span>
<span class="fc" id="L84">        statusLabel.setText(&quot;&quot;);</span>
<span class="fc" id="L85">    }</span>

    /** Apply localized strings and orientation to controls. */
    private void updateTexts() {
<span class="fc" id="L89">        newNoteBtn.setText(text(&quot;btn.new&quot;));</span>
<span class="fc" id="L90">        deleteBtn.setText(text(&quot;btn.delete&quot;));</span>
<span class="fc" id="L91">        toggleSidebarBtn.setText(text(&quot;btn.notes&quot;));</span>
<span class="fc" id="L92">        logoutBtn.setText(text(&quot;button.logout&quot;));</span>

<span class="fc" id="L94">        searchField.setPromptText(text(&quot;placeholder.search&quot;));</span>
<span class="fc" id="L95">        titleField.setPromptText(text(&quot;placeholder.title&quot;));</span>
<span class="fc" id="L96">        contentArea.setPromptText(text(&quot;placeholder.content&quot;));</span>

        // Adjust orientation for RTL languages (Arabic) so input aligns naturally
<span class="fc bfc" id="L99" title="All 2 branches covered.">        var orientation = isArabic</span>
<span class="fc" id="L100">                ? javafx.geometry.NodeOrientation.RIGHT_TO_LEFT</span>
<span class="fc" id="L101">                : javafx.geometry.NodeOrientation.LEFT_TO_RIGHT;</span>

<span class="fc" id="L103">        titleField.setNodeOrientation(orientation);</span>
<span class="fc" id="L104">        contentArea.setNodeOrientation(orientation);</span>
<span class="fc" id="L105">        searchField.setNodeOrientation(orientation);</span>
<span class="fc" id="L106">    }</span>

    /** Get a localized value or a placeholder if missing. */
    private String text(String key) {
<span class="fc" id="L110">        return localization.getOrDefault(key, &quot;[&quot; + key + &quot;]&quot;);</span>
    }

    // ---------------------------------------------
    //  LANGUAGE SWITCHING
    // ---------------------------------------------

    /** Switch to a new global language and reload UI. */
    public void setLanguage(String langCode) {
<span class="fc" id="L119">        View.currentLanguage = langCode;</span>
<span class="fc" id="L120">        loadLanguage();</span>
<span class="fc" id="L121">    }</span>

    @FXML
    private void onSwitchToEnglish() {
<span class="fc" id="L125">        setLanguage(&quot;en&quot;);</span>
<span class="fc" id="L126">    }</span>

    @FXML
    private void onSwitchToArabic() {
<span class="fc" id="L130">        setLanguage(&quot;ar&quot;);</span>
<span class="fc" id="L131">    }</span>

    @FXML
    private void onSwitchToJapanese() {
<span class="fc" id="L135">        setLanguage(&quot;ja&quot;);</span>
<span class="fc" id="L136">    }</span>

    // ---------------------------------------------
    //  TIMER LOGIC
    // ---------------------------------------------

    /** Prepare timer mechanism used for timed writing sessions. */
    private void setupTimer() {
        // Tick every second and update on UI thread
<span class="nc" id="L145">        timer = new Timeline(new KeyFrame(Duration.seconds(1), e -&gt; Platform.runLater(this::updateTimer)));</span>
<span class="nc" id="L146">        timer.setCycleCount(Timeline.INDEFINITE);</span>
<span class="nc" id="L147">        updateTimerDisplay();</span>
<span class="nc" id="L148">    }</span>

    /** Handle timer label clicks to start/stop a timed session. */
    @FXML
    private void onTimerClicked() {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (timer == null) setupTimer();</span>
<span class="nc" id="L154">        toggleTimer();</span>
<span class="nc" id="L155">    }</span>

    /**
     * Toggle timer playback and editor state.
     * When starting: reset to full duration, clear fields, focus editor.
     * When stopping (or completing): delegate to stopAndSave.
     */
    private void toggleTimer() {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!isTimerRunning) {</span>
<span class="nc" id="L164">            isTimerRunning = true;</span>
<span class="nc" id="L165">            timeRemaining = 15 * 60; // reset to 15 minutes for each session</span>
<span class="nc" id="L166">            updateTimerDisplay();</span>
<span class="nc" id="L167">            timer.play();</span>

            // Enable editing for a fresh session
<span class="nc" id="L170">            titleField.setEditable(true);</span>
<span class="nc" id="L171">            contentArea.setEditable(true);</span>
<span class="nc" id="L172">            titleField.clear();</span>
<span class="nc" id="L173">            contentArea.clear();</span>
<span class="nc" id="L174">            contentArea.requestFocus();</span>
        } else {
<span class="nc" id="L176">            stopAndSave();</span>
        }
<span class="nc" id="L178">    }</span>

    /**
     * Decrement timer and update UI; auto-save when time reaches zero.
     * Changes label color to red when under 60 seconds.
     */
    private void updateTimer() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (timeRemaining &gt; 0) {</span>
<span class="nc" id="L186">            timeRemaining--;</span>
<span class="nc" id="L187">            updateTimerDisplay();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (timeRemaining &lt;= 60) {</span>
<span class="nc" id="L189">                timerLabel.setStyle(&quot;-fx-text-fill: darkred;&quot;);</span>
            }
        } else {
            // Time's up: stop and persist the note (if valid)
<span class="nc" id="L193">            stopAndSave();</span>
        }
<span class="nc" id="L195">    }</span>

    /** Update formatted MM:SS display. */
    private void updateTimerDisplay() {
<span class="fc" id="L199">        int minutes = timeRemaining / 60;</span>
<span class="fc" id="L200">        int seconds = timeRemaining % 60;</span>
<span class="fc" id="L201">        timerLabel.setText(String.format(&quot;%02d:%02d&quot;, minutes, seconds));</span>
<span class="fc" id="L202">    }</span>

    /**
     * Stop timer and save note if title/content are present.
     * If content exists but title is empty, auto-generate a timestamped title.
     */
    private void stopAndSave() {
<span class="fc" id="L209">        isTimerRunning = false;</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (timer != null) timer.stop();</span>

<span class="fc" id="L212">        String title = titleField.getText().trim();</span>
<span class="fc" id="L213">        String content = contentArea.getText().trim();</span>

        // Auto-title convenience for quick writing sessions
<span class="pc bpc" id="L216" title="1 of 4 branches missed.">        if (title.isEmpty() &amp;&amp; !content.isEmpty()) {</span>
            title = &quot;Timed Session - &quot; +
<span class="fc" id="L218">                    LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;MM-dd HH:mm&quot;));</span>
        }

<span class="pc bpc" id="L221" title="2 of 4 branches missed.">        if (!title.isEmpty() &amp;&amp; !content.isEmpty()) {</span>
<span class="fc" id="L222">            int userId = View.loggedInUser.getUserId();</span>
<span class="fc" id="L223">            Note note = new Note(userId, title, content);</span>
<span class="fc" id="L224">            noteDAO.addNote(note);</span>

            // Update list only if it's a new title to avoid duplicates
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">            if (!allNotes.contains(title)) {</span>
<span class="fc" id="L228">                allNotes.add(title);</span>
<span class="fc" id="L229">                filterNotes(searchField.getText());</span>
<span class="fc" id="L230">                noteList.setItems(filteredNotes);</span>
            }

<span class="fc" id="L233">            setStatus(text(&quot;msg.noteSaved&quot;) + &quot;: &quot; + title, color);</span>
<span class="fc" id="L234">        } else {</span>
<span class="nc" id="L235">            setStatus(text(&quot;msg.noteNotSaved&quot;), &quot;#ee0000&quot;);</span>
        }

<span class="fc" id="L238">        resetTimer();</span>
<span class="fc" id="L239">    }</span>

    /** Reset timer and editor to default state. */
    private void resetTimer() {
<span class="fc" id="L243">        timeRemaining = 15 * 60;</span>
<span class="fc" id="L244">        updateTimerDisplay();</span>
<span class="fc" id="L245">        titleField.clear();</span>
<span class="fc" id="L246">        contentArea.clear();</span>
<span class="fc" id="L247">        titleField.setEditable(false);</span>
<span class="fc" id="L248">        contentArea.setEditable(false);</span>
<span class="fc" id="L249">        timerLabel.setStyle(&quot;-fx-text-fill: black;&quot;);</span>
<span class="fc" id="L250">    }</span>

    /** Load titles from the database for the current user. */
    private void loadNotesFromDB() {
<span class="nc" id="L254">        int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L255">        List&lt;Note&gt; notes = noteDAO.getNotesForUser(userId);</span>
<span class="nc" id="L256">        allNotes.clear();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        for (Note note : notes) {</span>
<span class="nc" id="L258">            allNotes.add(note.getTitle());</span>
<span class="nc" id="L259">        }</span>
<span class="nc" id="L260">        filteredNotes.setAll(allNotes);</span>
<span class="nc" id="L261">        noteList.setItems(filteredNotes);</span>
<span class="nc" id="L262">    }</span>

    /**
     * Filter list by query, preserving case-insensitive matching.
     * Empty query shows all notes.
     */
    private void filterNotes(String filter) {
<span class="fc" id="L269">        filteredNotes.clear();</span>
<span class="pc bpc" id="L270" title="2 of 4 branches missed.">        if (filter == null || filter.isBlank()) {</span>
<span class="fc" id="L271">            filteredNotes.addAll(allNotes);</span>
        } else {
<span class="nc" id="L273">            String f = filter.toLowerCase();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            for (String n : allNotes) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                if (n.toLowerCase().contains(f)) {</span>
<span class="nc" id="L276">                    filteredNotes.add(n);</span>
                }
<span class="nc" id="L278">            }</span>
        }
<span class="fc" id="L280">    }</span>

    /** Load selected note content into the editor. */
    private void loadSelectedNote() {
<span class="nc" id="L284">        String selected = noteList.getSelectionModel().getSelectedItem();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (selected != null) {</span>
<span class="nc" id="L286">            titleField.setText(selected);</span>
<span class="nc" id="L287">            int userId = View.loggedInUser.getUserId();</span>
<span class="nc" id="L288">            String content = noteDAO.getNoteByTitle(userId, selected);</span>
<span class="nc" id="L289">            contentArea.setText(content);</span>
        }
<span class="nc" id="L291">    }</span>

    /** Prepare a new note for editing. */
    @FXML
    private void onNewNote(ActionEvent event) {
<span class="fc" id="L296">        titleField.setEditable(true);</span>
<span class="fc" id="L297">        contentArea.setEditable(true);</span>
<span class="fc" id="L298">        titleField.clear();</span>
<span class="fc" id="L299">        contentArea.clear();</span>
<span class="fc" id="L300">        setStatus(text(&quot;msg.newNote&quot;), color);</span>
<span class="fc" id="L301">    }</span>

    /** Delete the selected note and update the list. */
    @FXML
    private void onDelete(ActionEvent event) {
<span class="fc" id="L306">        String selectedNote = noteList.getSelectionModel().getSelectedItem();</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (selectedNote != null) {</span>
<span class="fc" id="L308">            int userId = View.loggedInUser.getUserId();</span>
<span class="fc" id="L309">            noteDAO.deleteNoteByTitle(userId, selectedNote);</span>
<span class="fc" id="L310">            allNotes.remove(selectedNote);</span>
<span class="fc" id="L311">            filterNotes(searchField.getText());</span>
<span class="fc" id="L312">            noteList.setItems(filteredNotes);</span>
<span class="fc" id="L313">            setStatus(text(&quot;msg.noteDeleted&quot;) + &quot;: &quot; + selectedNote, color);</span>
<span class="fc" id="L314">        } else {</span>
<span class="fc" id="L315">            setStatus(text(&quot;msg.selectNote&quot;), &quot;#007bff&quot;);</span>
        }
<span class="fc" id="L317">    }</span>

    /** Show/hide sidebar containing the notes list. */
    @FXML
    private void onToggleSidebar(ActionEvent event) {
<span class="fc bfc" id="L322" title="All 2 branches covered.">        if (isSidebarHidden) {</span>
<span class="fc" id="L323">            rootPane.setRight(sidebar);</span>
        } else {
<span class="fc" id="L325">            rootPane.setRight(null);</span>
        }
<span class="fc bfc" id="L327" title="All 2 branches covered.">        isSidebarHidden = !isSidebarHidden;</span>
<span class="fc" id="L328">    }</span>

    /**
     * Display a temporary status message with color.
     * Clears itself after 4 seconds.
     */
    private void setStatus(String msg, String color) {
<span class="fc" id="L335">        statusLabel.setText(msg);</span>
<span class="fc" id="L336">        statusLabel.setStyle(&quot;-fx-text-fill: &quot; + color + &quot;;&quot;);</span>

<span class="fc" id="L338">        Timeline clearStatus = new Timeline(new KeyFrame(Duration.seconds(4), e -&gt; {</span>
<span class="nc" id="L339">            statusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L340">            statusLabel.setStyle(&quot;-fx-text-fill: transparent;&quot;);</span>
<span class="nc" id="L341">        }));</span>
<span class="fc" id="L342">        clearStatus.setCycleCount(1);</span>
<span class="fc" id="L343">        clearStatus.play();</span>
<span class="fc" id="L344">    }</span>

    /** Log out and return to login view. */
    @FXML
    private void onLogout() {
<span class="fc" id="L349">        View.loggedInUser = null;</span>
<span class="fc" id="L350">        View.isLoggedIn = false;</span>
<span class="fc" id="L351">        View.switchScene(View.primaryStage, &quot;/fxml/login-view.fxml&quot;);</span>
<span class="fc" id="L352">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>